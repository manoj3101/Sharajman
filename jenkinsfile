pipeline {
    agent any

    environment {
        NODE_VERSION = 'v20.9.0'  // Specify the Node.js version you want to use
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout your source code from your version control system (e.g., Git)
                checkout scm
            }
        }


        stage('Install Node.js') {
            steps {
                // Download and install Node.js using the official Windows installer
                bat "curl -o nodejs-setup.exe https://nodejs.org/dist/${NODE_VERSION}/node-${NODE_VERSION}-x64.msi"
                
                // Add Node.js installation directory to the system PATH
                bat 'setx PATH "%PATH%;D:\\node js" /M'
                
                // Verify Node.js installation
                bat 'node -v'
                bat 'npm -v'
                bat 'npx -v'
            }
        }

        stage('Install Dependencies') {
            steps {
                // Install project dependencies using npm
                bat 'npm install'
                bat 'npx playwright install'

                // Install Allure Commandline globally
                bat 'npm install -g allure-commandline'
            }
        }

        stage('Run Playwright Tests') {
            steps {
                script {
                    // Run Playwright tests in headless mode
                    bat 'npx playwright test'
                }
            }
        }

        stage('Publish HTML Report') {
            steps {
                // Archive your HTML report files (e.g., generated by your build)
                archiveArtifacts allowEmptyArchive: true, artifacts: 'my-allure-report/index.html', onlyIfSuccessful: false
                
                // Publish the HTML report using the HTML Publisher plugin
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: false,
                    keepAll: true,
                    reportDir: 'my-allure-report', // Specify the directory containing your HTML reports
                    reportFiles: 'index.html', // Specify the main HTML file(s) to publish
                    reportName: 'My HTML Report' // Give your report a name
                ])
            }
        }
    }

    post {
        always {
            // This script block will always run, regardless of the previous stages' status

            // Generate Allure Report
            bat 'npx allure generate --clean ./my-allure-report'

            // Start Allure Server
            // bat 'npx allure open'

            // Wait for a while for the Allure server to start
            timeout(time: 60, unit: 'SECONDS') {
                // Access Allure Report
                bat 'cd C:\ProgramData\Jenkins\.jenkins\workspace\sharajman\allure-report\'
                bat 'start chrome index.html'
                
                // Send an email notification with the Allure report as an attachment
                // emailext(
                //     subject: 'Allure Report',
                //     body: 'Please find the attached Allure report.',
                //     attachmentsPattern: '**/my-allure-report.zip', // Assuming your report is in a zip file
                //     to: 'manojkumar.s@tickingminds.com', // Replace with the recipient's email address
                //     recipientProviders: [[$class: 'DevelopersRecipientProvider']]
                // )
            }
        }
    }
}